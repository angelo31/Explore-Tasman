<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=320 user-scalable=no" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>ColorThief Demo</title>
    <script type="text/javascript" src="phonegap.js"></script>

    <!-- Jquery and Jquery mobile -->
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css" />
    <script src="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>

    <!-- gmap3 -->
    <script src="http://cdn.jsdelivr.net/gmap3/5.1.1/gmap3.min.js"></script>

    <!-- jQuery Validation plugin -->
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.12.0/jquery.validate.min.js"></script>
    
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.12.0/additional-methods.min.js"></script>



    <style>
    #yourimage {
      width: 50%;
      /*height: 15%;  */
  }
  #swatches {
      width: 100%;
      height: 50px; 
  }
  .swatch {
      width:18%;
      height: 50px;
      border-style:solid;
      border-width:thin;    
      float: left;
      margin-right: 3px;    
  }

  #map {
   /*height: 100%;*/
   height: 500px;

   width: 100%;
}

img {
    width: 25%;
}

img:hover {
    width: 100%;
}

label.error {
    /*float: none; */
    color: red; 
    font-size: 16px;
    font-weight: normal;
    line-height: 1.4;
    padding-left: 5px
}

</style>
</head>

<body>

    <!-- <div role="main" class="ui-content"> -->
    <div data-role="content">

        <form method="post" enctype="multipart/form-data" action="/upload">
            <input type="file" id = "files" capture="camera" accept="image/*" id="takePictureField" name='image'/>
            <input type="submit" value="submit"/>
        </form>

        <h2>Upload to s3</h2>
        <form id="form1" enctype="multipart/form-data" method="post" class="validate">
            <div class="row">
                <fieldset data-role="fieldcontain">
                    <!-- <label for = "IDText" class="ui-hidden-accessible">User ID:</label> -->
                    <input name = "IDText" id = "IDText" type = "text" placeholder = "User ID">
                </fieldset>

                <fieldset data-role="fieldcontain">
                    <!-- <label for = "ImageNameText">Image name:</label> -->
                    <input name = "ImageNameText" id = "ImageNameText" type = "text" placeholder = "Image name">
                </fieldset>

                <fieldset data-role="fieldcontain">
                    <!-- <label for = "descText">Description:</label> -->
                    <input name = "descText" id = "descText" type = "text" placeholder = "Description"> 
                </fieldset>

                <fieldset data-role="fieldcontain">
                    <select name="category">
                        <option selected disabled>Choose category</option>
                        <option value="animals">Animals</option>
                        <option value="plants">Plants</option>
                        <option value="other">Other</option>
                    </select>
                </fieldset>

                <fieldset data-role="fieldcontain">
                    <label for="file">Select a File to Upload</label>
                    <input type="file" name="file" id="file" capture="camera" accept="image/*" />
                </fieldset>

                <div class="row">
                    <!-- <input type="button" value="Upload" id = "sendButton"/> -->
                    <button type="submit" class="btnLogin" data-theme="a" id="sendButton">Upload</button>


                </div>
                <div id="progressNumber"></div>
                <input type="button" value="get image" id = "getButton"/>
            </form>

            <img id="yourimage"/>

            <input type="button" value="show map" id = "mapButton"/>

            <div id="map"></div> <!-- testing map-->

        </div>
    </div>

    <script>
    var desiredWidth;
    $(document).ready(function () {
        console.log('onReady');
        $("#takePictureField").on("change", gotPic);
    // $("#yourimage").load(getSwatches);
    desiredWidth = window.innerWidth;

    if (!("url" in window) && ("webkitURL" in window)) {
        window.URL = window.webkitURL;
    }
});

    function getSwatches() {
        var colorArr = createPalette($("#yourimage"), 5);
        for (var i = 0; i < Math.min(5, colorArr.length); i++) {
            $("#swatch" + i).css("background-color", "rgb(" + colorArr[i][0] + "," + colorArr[i][1] + "," + colorArr[i][2] + ")");
            console.log($("#swatch" + i).css("background-color"));
        }
    }

//Credit: https://www.youtube.com/watch?v=EPYnGFEcis4&feature=youtube_gdata_player
function gotPic(event) {
    if (event.target.files.length == 1 && event.target.files[0].type.indexOf("image/") == 0) {
        var blob = event.target.files[0];
        // $("#yourimage").attr("src", URL.createObjectURL(blob)); //makes it able to display blob as an image....
    }

    var reader = new window.FileReader();
    reader.readAsDataURL(blob);
    var base64data;
    var js;
    reader.onloadend = function () {
        base64data = reader.result;
        js = JSON.stringify(base64data);
        // console.log(base64data);
        var encodedData = window.btoa(blob); // encode a string
        var decodedData = window.atob(encodedData); // decode the string
    };
}
</script>

<script>
$.ajaxSetup ({
    cache: false
});

/*
$("#getButton").bind("click", function (event, ui) {
    var url = "http://intense-harbor-6396.herokuapp.com/url";
    // var url = "http://localhost:3000/url";
    /*$.get(url, function(data) {
        $("#yourimage").attr("src", data.url); //display image....
    })*/

	/*var src = getURL();
$("#yourimage").attr("src", src);

})*/

/* Form validation... */
$("#form1").validate({
    rules: {
        IDText: {
            required: true
        },
        ImageNameText: {
            required: true
        },
        descText: {
            minlength: 5
        },
        file: {
            required: true
        },

        submitHandler: function(form) {
            form.submit();
        }
    }
});

/* post form info to server */
$("#sendButton").bind("click", function (event, ui) {
    var url = "http://intense-harbor-6396.herokuapp.com/upload";
    // var url = "http://localhost:3000/upload";
    var file = document.getElementById('file').files[0];
    var key = "events/" + (new Date).getTime() + '-' + file.name; //uploads to this folder and name
    var id = $("#IDText").val();
    var imageName = $("#ImageNameText").val();
    var desc = $("#descText").val();
    var imgURL = "https://exploretasman.s3.amazonaws.com/" + key;

// if any fields are empty then cant upload
if (!id || !imageName) {
    // alert("Some fields are empty and need to be filled out! >:)");
}

else {
    uploadFile(file, key); //call so can upload file to S3

    var getURL = function() {
       return imgURL;
   };

   var inJSON = {"id": id, "imageName": imageName, "description": desc, "url": imgURL};
   console.log("posting: ", inJSON);

    // sending to server
    $.post(url, inJSON, function (data) {
    }, "json");

    // testing to show img on page
    $("#getButton").bind("click", function (event, ui) {
        var url = "http://intense-harbor-6396.herokuapp.com/url";
        var src = getURL();
        $("#yourimage").attr("src", src);
    });
}

});

// uploading file to s3 bucket
function uploadFile(file, key) {
    var fd = new FormData();
    // var file = document.getElementById('file').files[0];
    fd.append('key', key);
    fd.append('acl', 'public-read'); 
    fd.append('Content-Type', file.type);      
    fd.append('AWSAccessKeyId', 'AKIAJJUYC4EAIF7D2XDQ');
    fd.append('policy', policyBase64)
    fd.append('signature',"sGRBx76tlCjZ8xTTPZS7wT/q+oQ=");
    fd.append("file",file);

    var xhr = new XMLHttpRequest();
    xhr.upload.addEventListener("progress", uploadProgress, false);
    xhr.addEventListener("load", uploadComplete, false);
    xhr.addEventListener("error", uploadFailed, false);
    xhr.addEventListener("abort", uploadCanceled, false);

    xhr.open('POST', 'https://exploretasman.s3.amazonaws.com/', true); //MUST BE LAST LINE BEFORE YOU SEND 
    xhr.send(fd);
}

function uploadProgress(evt) {
    if (evt.lengthComputable) {
      var percentComplete = Math.round(evt.loaded * 100 / evt.total);
      document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
  }
  else {
      document.getElementById('progressNumber').innerHTML = 'unable to compute';
  }
}

function uploadComplete(evt) {
    /* This event is raised when the server send back a response */
    alert("Upload complete!" + evt.target.responseText );
}

function uploadFailed(evt) {
    alert("There was an error attempting to upload the file." + evt);
}

function uploadCanceled(evt) {
    alert("The upload has been canceled by the user or the browser dropped the connection.");
}

// var experiation = new Date(new Date().getTime() + 1000 * 60 * 5).toISOString();
POLICY_JSON = { "expiration": "2020-12-01T12:00:00.000Z",
"conditions": [
{"bucket": "exploretasman"},
["starts-with", "$key", ""],
{"acl": "public-read"},                           
["starts-with", "$Content-Type", ""],
["content-length-range", 0, 524288000] //max file size is 500MB?
]};

var secret64 = "dG1MRDNQOEl3ZlVic1hxN3Y4NzFldmJaeWplaDE1dkVudk1ZbEZHZw==";
var secret = window.atob(secret64);

var policy = JSON.stringify(POLICY_JSON);
var policyBase64 = window.btoa(policy);


/* GMAP STUFF */
$("#mapButton").bind("click", function (event, ui) {
    var url = "http://intense-harbor-6396.herokuapp.com/gps";
    // var url = "http://localhost:3000/gps";
    var data = [];

    $.get(url, function (gps) {
        data = gps;
        mapStuff(data)
    })
})

function mapStuff(data) {
    var $map = $("#map");

    // Gmap Defaults
    $map.gmap3({
        map: {
            options: {
                center: [-40.9382511,172.9681819],
                zoom: 12,
                minZoom: 11,
                disableDefaultUI: true,
                // bounds: {n:-40.793657, e:173.075851, s:-41.005412, w:172.834839},
            }
        }
    });

    // Json Loop
    $.each(data, function (key, val) {
        $map.gmap3({
            marker: {
                values: [{
                    address: val.address,
                    options: {
                        icon: val.icon,
                    },
                    events: {
                        click: function (marker, event, context) {
                            gmap_clear_markers();
                            $map.gmap3({
                                map: {
                                    options: {
                                        // center:event.latLng
                                    }
                                }
                            });
                            var infowindows = $(this).gmap3({
                                overlay: {
                                    address: val.address,
                                    options: {
                                        content: '<div class="infobox">'+val.content+'</div>',
                                        offset: {
                                            y: -32,
                                            x: 12
                                        }
                                    }
                                }
                            });
                        }
                    }
                }]
            }
        });
});
    // Function Clear Markers
    function gmap_clear_markers() {
        $('.infobox').each(function () {
            $(this).remove();
        });
    }
}
</script>
</body>
</html>
