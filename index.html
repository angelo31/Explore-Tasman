<!DOCTYPE HTML>
<html>
<head>
	<meta name="viewport" content="width=320 user-scalable=no" />
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>ColorThief Demo</title>

	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	<!-- // <script type="text/javascript" charset="utf-8" src="quantize.js"></script> -->
	<!-- // <script type="text/javascript" charset="utf-8" src="color-thief.js"></script> -->
	<!-- // <script type="text/javascript" charset="utf-8" src="jquery.form.js"></script> -->

	<!-- // <script type="text/javascript" src="js/lodash.min.js"></script> -->
    <!-- // <script type="text/javascript" src="js/s3upload.js"></script> -->

    <style>
    #yourimage {
      width: 15%;	
      height: 15%;	
  }
  #swatches {
      width: 100%;
      height: 50px;	
  }
  .swatch {
      width:18%;
      height: 50px;
      border-style:solid;
      border-width:thin;	
      float: left;
      margin-right: 3px;	
  }
  </style>
</head>

<body>
	<form method="post" enctype="multipart/form-data" action="/upload">
		<input type="file" id = "files" capture="camera" accept="image/*" id="takePictureField" name='image'/>
		<input type="submit"/>
	</form>

	<form id="form1" enctype="multipart/form-data" method="post">
		<div class="row">
			<label for="file">Select a File to Upload</label><br />
			<input type="file" name="file" id="file" capture="camera" accept="image/*" />
		</div>
		<!-- <div id="fileName"></div> -->
		<!-- <div id="fileSize"></div> -->
		<!-- <div id="fileType"></div> -->
		<div class="row">
			<input type="button" onclick="uploadFile()" value="Upload" />
            <!-- <input type="button" onclick="s3uploader()" value="Upload" /> -->

        </div>
        <div id="progressNumber"></div>
    </form>

        <img id="yourimage"> 

<!-- 	<div id="swatches">
		<div id="swatch0" class="swatch"></div>
		<div id="swatch1" class="swatch"></div>
		<div id="swatch2" class="swatch"></div>
		<div id="swatch3" class="swatch"></div>
		<div id="swatch4" class="swatch"></div>
	</div> -->

	<script>
	var desiredWidth;
	$(document).ready(function() {
		console.log('onReady');
		$("#takePictureField").on("change",gotPic);
		// $("#yourimage").load(getSwatches);
		desiredWidth = window.innerWidth;

		if(!("url" in window) && ("webkitURL" in window)) {
			window.URL = window.webkitURL;   
		}
	});

	function getSwatches(){
		var colorArr = createPalette($("#yourimage"), 5);
		for (var i = 0; i < Math.min(5, colorArr.length); i++) {
			$("#swatch"+i).css("background-color","rgb("+colorArr[i][0]+","+colorArr[i][1]+","+colorArr[i][2]+")");
			console.log($("#swatch"+i).css("background-color"));
		}
	}
	
    //Credit: https://www.youtube.com/watch?v=EPYnGFEcis4&feature=youtube_gdata_player
    function gotPic(event) {
    	if(event.target.files.length == 1 && 
    		event.target.files[0].type.indexOf("image/") == 0) {

    		var blob = event.target.files[0]
    		// $("#yourimage").attr("src", URL.createObjectURL(blob)); //makes it able to display blob as an image....
    	}

    	var reader = new window.FileReader();
    	reader.readAsDataURL(blob);
    	var base64data;
    	var js;
    	reader.onloadend = function() {
    		base64data = reader.result;
    		js = JSON.stringify(base64data)
    		// console.log(base64data);
    		
    // var image = new Image();
    // image.src = base64data;
    // document.body.appendChild(image);
    var encodedData = window.btoa(blob); // encode a string
    var decodedData = window.atob(encodedData); // decode the string
}

}
</script>

<script>

function s3uploader() {
    var signingURI = "130.195.4.176:3000/signing"

    function upload (imageURI, fileName) {
        var deferred = $.Deferred(),
        file = document.getElementById('file').files[0],
        fd = new FormData();
        var key = "events/" + (new Date).getTime() + '-' + file.name; //uploads to this folder and name


        var xhr = new XMLHttpRequest();

        $.ajax({url: signingURI, data: {"fileName": key}, dataType: "json"})
        .done(function (data) {
            
        fd.append('key', key);
        fd.append('acl', 'public-read'); 
        fd.append('Content-Type', file.type);      
        fd.append('AWSAccessKeyId', data.awsKey);
        fd.append('policy', policyBase64)
        fd.append('signature', data.signature);

        fd.append("file",file);

    xhr.upload.addEventListener("progress", uploadProgress, false);
    xhr.addEventListener("load", uploadComplete, false);
    xhr.addEventListener("error", uploadFailed, false);
    xhr.addEventListener("abort", uploadCanceled, false);

    xhr.open('POST', 'https://exploretasman.s3.amazonaws.com/', true); //MUST BE LAST LINE BEFORE YOU SEND 

    xhr.send(fd);
            

        })
        .fail(function (error) {
            console.log(JSON.stringify(error));
        });

        return deferred.promise();

    }

    return {
        upload: upload
    }
}

function uploadFile() {

    var file = document.getElementById('file').files[0];
    var fd = new FormData();

    var key = "events/" + (new Date).getTime() + '-' + file.name; //uploads to this folder and name

    fd.append('key', key);
    fd.append('acl', 'public-read'); 
    fd.append('Content-Type', file.type);      
    fd.append('AWSAccessKeyId', 'AKIAJJUYC4EAIF7D2XDQ');
    fd.append('policy', policyBase64)
    fd.append('signature',"sGRBx76tlCjZ8xTTPZS7wT/q+oQ=");

    fd.append("file",file);

    var xhr = new XMLHttpRequest();

    xhr.upload.addEventListener("progress", uploadProgress, false);
    xhr.addEventListener("load", uploadComplete, false);
    xhr.addEventListener("error", uploadFailed, false);
    xhr.addEventListener("abort", uploadCanceled, false);

    xhr.open('POST', 'https://exploretasman.s3.amazonaws.com/', true); //MUST BE LAST LINE BEFORE YOU SEND 

    xhr.send(fd);
}

function uploadProgress(evt) {
    if (evt.lengthComputable) {
      var percentComplete = Math.round(evt.loaded * 100 / evt.total);
      document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
  }
  else {
      document.getElementById('progressNumber').innerHTML = 'unable to compute';
  }
}

function uploadComplete(evt) {
    /* This event is raised when the server send back a response */
    alert("Upload complete!" + evt.target.responseText );
}

function uploadFailed(evt) {
    alert("There was an error attempting to upload the file." + evt);
}

function uploadCanceled(evt) {
    alert("The upload has been canceled by the user or the browser dropped the connection.");
}

var experiation = new Date(new Date().getTime() + 1000 * 60 * 5).toISOString();

POLICY_JSON = { "expiration": "2020-12-01T12:00:00.000Z",
"conditions": [
{"bucket": "exploretasman"},
["starts-with", "$key", ""],
{"acl": "public-read"},                           
["starts-with", "$Content-Type", ""],
["content-length-range", 0, 524288000] //max file size is 500MB?
]
};

var secret64 = "dG1MRDNQOEl3ZlVic1hxN3Y4NzFldmJaeWplaDE1dkVudk1ZbEZHZw==";
var secret = window.atob(secret64);

var policy = JSON.stringify(POLICY_JSON);
    // var policyBase64 = Base64.encode(policy);
    var policyBase64 = window.btoa(policy);

    // var policyBase64 = "eyJleHBpcmF0aW9uIjoiMjAyMC0xMi0wMVQxMjowMDowMC4wMDBaIiwiY29uZGl0aW9ucyI6W3siYnVja2V0IjoiZXhwbG9yZXRhc21hbiJ9LFsic3RhcnRzLXdpdGgiLCIka2V5IiwiIl0seyJhY2wiOiJwdWJsaWMtcmVhZCJ9LFsic3RhcnRzLXdpdGgiLCIkQ29udGVudC1UeXBlIiwiIl0sWyJjb250ZW50LWxlbmd0aC1yYW5nZSIsMCw1MjQyODgwMDBdXX0=" 

    // var signature = "373d4d4a847056a79c9f80a86a6875ee6bb89f08"
    // console.log ( policyBase64 )

	// var signature = crypto.createHmac('sha1', secret).update(policyBase64).digest('base64');
    </script>

</body>
</html>