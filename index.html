<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=320 user-scalable=no" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Explore Tasman</title>
    <script type="text/javascript" src="phonegap.js"></script>

    <!-- Jquery and Jquery mobile -->
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css" />
    <script src="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>

    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>

    <!-- gmap3 -->
    <script src="http://cdn.jsdelivr.net/gmap3/5.1.1/gmap3.min.js"></script>

    <!-- jQuery Validation plugin -->
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.12.0/jquery.validate.min.js"></script>
    
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.12.0/additional-methods.min.js"></script>

    <style>
    #yourimage {
      width: 25%;
  }

  #map {
    /*height: 100%;*/
    height: 500px;
    width: 100%;
}

.images {
   width: 90%;
   display: block;
   margin-left: auto;
   margin-right: auto;
}

/*img:hover {
    width: 100%;
    }*/

    label.error {
        color: red; 
        font-size: 16px;
        font-weight: normal;
        line-height: 1.4;
        padding-left: 5px
    }

    </style>
</head>

<body>
    <!-- <div role="main" class="ui-content"> -->
    <div data-role="content">

<!--
        <form method="post" enctype="multipart/form-data" action="/upload">
            <input type="file" id = "files" capture="camera" accept="image/*" id="takePictureField" name='image'/>
            <input type="submit" value="submit"/>
        </form>
    -->

    <h2>Upload to s3</h2>
    <form id="form1" enctype="multipart/form-data" method="post" class="validate">
        <div class="row">
            <fieldset data-role="fieldcontain">
                <!-- <label for=" IDText" class="ui-hidden-accessible">User ID:</label> -->
                <input name="IDText" id="IDText" type="text" placeholder="User ID"/>
            </fieldset>
            <fieldset data-role="fieldcontain">
                <!-- <label for=" TitleText">Title:</label> -->
                <input name="TitleText" id="TitleText" type="text" placeholder="Title" data-clear-btn="true"/>
            </fieldset>
            <fieldset data-role="fieldcontain">
                <!-- <label for=" descText">Description:</label> -->
                <input name="descText" id="descText" type="text" placeholder="Description" data-clear-btn="true"/>
            </fieldset>
            <fieldset data-role="fieldcontain">
                <select name="category" id="categoryText">
                    <option selected disabled>Choose category</option>
                    <option value="Animals">Animals</option>
                    <option value="Plants">Plants</option>
                    <option value="Other">Other</option>
                </select>
            </fieldset>
            <fieldset data-role="fieldcontain">
                <label for="file">Select a File to Upload</label>
                <input type="file" name="file" id="file" capture="camera" accept="image/*" />
            </fieldset>
            <fieldset data-role="fieldcontain" class="ui-screen-hidden">
                <input name="locationText" id="locationText" type="text"/>
            </fieldset>
            <div data-role="controlgroup">
                <button type="submit" data-role="button" id="sendButton" data-icon="check" data-iconpos="right">Upload</button>
                <!-- <button type="reset" data-icon="delete" data-iconpos="right" id="cancelButton">Cancel</button> -->
            </div>
            <img id="yourimage"/>
            <div id="progressNumber"></div>
        </form>

        <!-- <input type="button" value="show map" id = "mapButton"/> -->
        <div id="map"></div> <!-- testing map-->
        <fieldset data-role="controlgroup">
            <legend>Filter categories:</legend>

            <input type="radio" name="radio-choice" id="allButton" value="All">
            <label for="allButton">All</label>

            <input type="radio" name="radio-choice" id="animalButton" value="Animals">
            <label for="animalButton">Animals</label>

            <input type="radio" name="radio-choice" id="plantButton" value="Plants">
            <label for="plantButton">Plants</label>

            <input type="radio" name="radio-choice" id="otherButton" value="Other">
            <label for="otherButton">Other</label>
        </fieldset>
    </div>
</div>

<script>
$(document).ready(function () {
    console.log('onReady');
    $("#file").on("change", previewImage);
});

//Credit: https://www.youtube.com/watch?v=EPYnGFEcis4&feature=youtube_gdata_player
function previewImage(event) {
    getLocation(); // get location of where user is uploading photo 
    if (event.target.files.length == 1 && event.target.files[0].type.indexOf("image/") == 0) {
        var blob = event.target.files[0];
         // $("#yourimage").attr("src", URL.createObjectURL(blob)); //makes it able to display blob as an image....
     }
 }
 </script>

 <script>
 $.ajaxSetup ({
    cache: false
});

 function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
    } else {
       alert("Geolocation is not supported :(");
   }
}

function showPosition(position) {
    var lat = position.coords.latitude;
    var lon = position.coords.longitude;
    var data = lat + "," + lon;
    $("#locationText").val(data);
}

function showError(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
        alert("User denied the request for Geolocation.");
        break;
        case error.POSITION_UNAVAILABLE:
        alert("Location information is unavailable.");
        break;
        case error.TIMEOUT:
        alert("The request to get user location timed out.");
        break;
        case error.UNKNOWN_ERROR:
        alert("An unknown error occurred.");
        break;
    }
}

/* Form validation... */
$("#form1").validate({
    rules: {
        IDText: {
            required: true
        },
        TitleText: {
            required: true
        },
        descText: {
            minlength: 5
        },
        categoryText: {
            required: true
        },
        file: {
            required: true,
            accept: "image/jpg, image/jpeg, image/png"
        },
        submitHandler: function(form) {
            // need something here
        }
    }
});

/* post form info to server */
$("#sendButton").bind("click", function (event, ui) {
    var file = document.getElementById('file').files[0];

    var img = document.getElementById("yourimage");
    img.src = window.URL.createObjectURL(file);

    var MAX_WIDTH = 800;
    var MAX_HEIGHT = 600;
    var width = img.width;
    var height = img.height;
    
    if (width > height) {
      if (width > MAX_WIDTH) {
        height *= MAX_WIDTH / width;
        width = MAX_WIDTH;
    }
} else {
  if (height > MAX_HEIGHT) {
    width *= MAX_HEIGHT / height;
    height = MAX_HEIGHT;
}
}
canvas.width = width;
canvas.height = height;
var ctx = canvas.getContext("2d");
ctx.drawImage(img, 0, 0, width, height);


    var key = "events/" + (new Date).getTime() + '-' + file.name; //uploads to this folder and name

    // getting values of form fields
    var id = $("#IDText").val();
    var title = $("#TitleText").val();
    var desc = $("#descText").val();
    var category = $("#categoryText").val();
    var imgURL = "https://exploretasman.s3.amazonaws.com/" + key;
    var gps = $("#locationText").val(); //location text


// if any fields are empty then cant upload
if (!id || !title || !category) {
    alert("Some fields are empty and need to be filled out!");
}

else {
    var url = "http://intense-harbor-6396.herokuapp.com/upload";
            // var url = "http://localhost:3000/upload";
            uploadFile(file, key); //call so can upload file to S3
            var inJSON = {
                "id": id,
                "title": title,
                "description": desc,
                "category": category,
                "gps": gps,
                "url": imgURL
            };
            console.log("posting: ", inJSON);

            // sending to server
            // $.post(url, inJSON, function (data) {
            // }, "json");

$.ajax({
    type: "POST",
    url: url,
    data: inJSON,
    dataType: "json",
    success:function(data) {
        alert("Upload complete!")
    },
    complete:function() {
        $("#form1").each(function(){
            this.reset();
        });
    }
});
}
});

// uploading file to s3 bucket
function uploadFile(file, key) {
    var fd = new FormData();
    fd.append('key', key);
    fd.append('acl', 'public-read'); 
    fd.append('Content-Type', file.type);      
    fd.append('AWSAccessKeyId', 'AKIAJJUYC4EAIF7D2XDQ');
    fd.append('policy', policyBase64)
    fd.append('signature',"sGRBx76tlCjZ8xTTPZS7wT/q+oQ=");
    fd.append("file",file);

    var xhr = new XMLHttpRequest();
    // xhr.upload.addEventListener("progress", uploadProgress, false);
    // xhr.addEventListener("load", uploadComplete, false);
    // xhr.addEventListener("error", uploadFailed, false);
    // xhr.addEventListener("abort", uploadCanceled, false);

    xhr.open('POST', 'https://exploretasman.s3.amazonaws.com/', true); //MUST BE LAST LINE BEFORE YOU SEND 
    xhr.send(fd);
}

function uploadProgress(evt) {
    if (evt.lengthComputable) {
      var percentComplete = Math.round(evt.loaded * 100 / evt.total);
      // document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
      $("#progressNumber").val(percentComplete.toString() + '%')
  }
  else {
      document.getElementById('progressNumber').innerHTML = 'unable to compute';
  }
}

function uploadComplete(evt) {
    /* This event is raised when the server send back a response */
    alert("Upload complete!" + evt.target.responseText );
}

function uploadFailed(evt) {
    alert("There was an error attempting to upload the file." + evt);
}

function uploadCanceled(evt) {
    alert("The upload has been canceled by the user or the browser dropped the connection.");
}

// var experiation = new Date(new Date().getTime() + 1000 * 60 * 5).toISOString();
POLICY_JSON = { "expiration": "2020-12-01T12:00:00.000Z",
"conditions": [
{"bucket": "exploretasman"},
["starts-with", "$key", ""],
{"acl": "public-read"},                           
["starts-with", "$Content-Type", ""],
["content-length-range", 0, 524288000] //max file size is 500MB?
]};

var secret64 = "dG1MRDNQOEl3ZlVic1hxN3Y4NzFldmJaeWplaDE1dkVudk1ZbEZHZw==";
var secret = window.atob(secret64);
var policy = JSON.stringify(POLICY_JSON);
var policyBase64 = window.btoa(policy);

/* Show map on screen */
var $map = $("#map");

    // Gmap Defaults
    $map.gmap3({
        map: {
            options: {
                // center: [-40.9382511,172.9681819],
                center: [-40.930, 173.0509],
                // center: [-41.24437,174.7618546],

                zoom: 12,
                minZoom: 11,
                disableDefaultUI: true,
                // bounds: {n:-40.793657, e:173.075851, s:-41.005412, w:172.834839},
            }
        }
    });


    /* show all categories */
    $("#allButton").bind("click", function (event, ui) {
        var url = "http://intense-harbor-6396.herokuapp.com/category/all";
    // var url = "http://localhost:3000/all";
    var data = [];
    $map.gmap3("clear");

    $.get(url, function (gps) {
        data = gps;
        mapStuff(data)
    });
});

    /* Show only animals */
    $("#animalButton").click(function () {
        var url = "http://intense-harbor-6396.herokuapp.com/category/animals";
    // var url = "http://localhost:3000/animals";
    var data = [];
    $map.gmap3("clear");

    $.get(url, function (gps) {
        data = gps;
        mapStuff(data)
    })
});

    /* show only plants */
    $("#plantButton").bind("click", function () {
        var url = "http://intense-harbor-6396.herokuapp.com/category/plants";
    // var url = "http://localhost:3000/plants";
    var data = [];
    $map.gmap3("clear");

    $.get(url, function (gps) {
        data = gps;
        mapStuff(data)
    })
});

    /* show only other */
    $("#otherButton").bind("click", function (event, ui) {
        var url = "http://intense-harbor-6396.herokuapp.com/category/other";
    // var url = "http://localhost:3000/other";
    var data = [];
    $map.gmap3("clear");

    $.get(url, function (gps) {
        data = gps;
        mapStuff(data)
    })
});

    /* Plot data onto map */
    function mapStuff(data) {
    // loop through data
    $.each(data, function (key, val) {

        var animalIcon = "img/wildlife.png";
        var plantIcon = "img/palm-tree-export.png";
        var otherIcon = "img/panoramicview.png";

        if (val.category == "Plants") {
            icon = plantIcon;
        }

        else if (val.category == "Other") {
            icon = otherIcon;
        }

        else {
            icon = animalIcon;
        }

        $map.gmap3({
            marker: {
                values: [{
                    address: val.gps,
                    options: {
                        icon: icon,
                        animation: google.maps.Animation.DROP,
                    },
                    events: {
                        click: function (marker, event, context) {
                            var map = $(this).gmap3("get"),
                            infowindow = $(this).gmap3({
                                get: {
                                    name: "infowindow"
                                }
                            });
                            if (infowindow) {
                              infowindow.open(map, marker);
                              infowindow.setContent("<h4>" + val.title + "</h4><br><img src ='" + val.imageurl + "'class = 'images'/><br><p>" + val.imagedesc + "</p>");
                          }
                          else {
                            $(this).gmap3({
                                infowindow: {
                                    address: val.gps,
                                    options: {
                                        maxWidth: 200,
                                        // content: '<div class="infobox">'+val.content+'</div>',
                                        // content: val.content,
                                        content: "<h4>" + val.title + "</h4><br><img src ='" + val.imageurl + "' class = 'images'/><br><p>" + val.imagedesc + "</p>",
                                        offset: {
                                            y: -32,
                                            x: 12
                                        }
                                    }
                                }
                            });
                        }
                    }, 
                    // close current infowindow 
                    closeclick: function () {
                        var infowindow = $(this).gmap3({
                            get: {
                                name: "infowindow"
                            }
                        });
                        if (infowindow) {
                            infowindow.close();
                        }
                    }
                } // end of events options 
            }]
        } // end of marker
    });
}); //end of loop
} //end of mapStuff function
</script>
</body>
</html>
